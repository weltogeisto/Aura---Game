name: Release Desktop

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (vMAJOR.MINOR.PATCH[-channel.N])'
        required: true

jobs:
  release-macos:
    name: Build + sign macOS desktop
    runs-on: macos-latest
    defaults:
      run:
        working-directory: aura-game
    env:
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
      APPLE_SIGNING_ENABLED: ${{ vars.APPLE_SIGNING_ENABLED }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: aura-game/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate release tag format and version mapping
        run: pnpm run release:tag:check "${{ github.event.inputs.release_tag || github.ref_name }}"

      - name: Build canonical web artifacts
        run: pnpm run build:canonical

      - name: Validate staged release artifacts
        run: pnpm run release:artifacts:validate

      - name: Run packaged-mode smoke checks
        run: pnpm run smoke:packaged

      - name: Decode signing certificate
        run: |
          echo "$APPLE_CERTIFICATE_P12_BASE64" | base64 --decode > signing-cert.p12
        env:
          APPLE_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}

      - name: Create keychain and import certificate
        run: |
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import signing-cert.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          security find-identity -v -p codesigning build.keychain
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Build signed + notarized macOS desktop bundle
        run: pnpm run desktop:bundle:beta:macos

      - name: Upload desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-macos-release-${{ github.ref_name }}
          path: |
            aura-game/src-tauri/target/universal-apple-darwin/release/bundle/**
            release/web/current/checksums.sha256
            release/web/current/dist/**
